#include <cstdio>
#include <iostream>
#include <cstdlib>
#include <string>
#include <conio.h>
#include <stdlib.h>
#include <Windows.h>
#include <vector>

using namespace std;

void GoToXY(int column, int line)
{
    COORD coord;            //Определяет координаты символьной ячейки в буфере экрана консоли.
    coord.X = column;
    coord.Y = line;

    HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);              //HANDLE - дескриптор, т.е. число, с помощью которого можно идентифицировать
                                                           //Можно провести аналогию с массивом : у нас имеется набор ресурсов, 
                                                                   ///а HANDLE - это индекс, который указывает на конкретный ресурс.
    if (!SetConsoleCursorPosition(hConsole, coord))
    {
        cout << endl << "Unexpected error occurred." << endl;
        system("pause");
        exit(1);
    }
}

void clear_window() {
    GoToXY(0, 0);
    for (int i = 0; i < 40; i++) {
        for (int j = 0; j < 40; j++) {
            GoToXY(i, j); cout << " ";
        }
    }
}

void aVer(double* arr, double* arrV, unsigned long Length) {                  //функция заполнения массива с вероятностью

    for (int i = 0; i < 256; i++) {
        arrV[i] = round((arr[i] / Length) * 1000000000) / 1000000000;           //округление до 9 знака после запятой значения вероятности
    }

}

void aAmount(double* arr, unsigned long* Length, char* argc) {               //функция заполнения массива с количеством. В массиве индекс-это сам байт, а элементы массива-это значения количества этих байтов соответственно
    FILE* file;                                     //Указатель на структуру FILE
    errno_t error = 0;                              //Errno – переменная, хранящая целочисленный код последней ошибки.
    error = fopen_s(&file, argc, "rb");     //fopen_s используется для открытия файлов в различных режимах.&file-Указывает на указатель файла, указывающий на открытый файл
                                            //argc – Обозначает имя файла, который будет открыт
                                            //rb – Режим доступа только для чтения, в котором открывается файл
    if (error != 0)
    {
        GoToXY(10, 10);
        cout << "Не удалось открыть файл ";
    }
    fseek(file, 0, SEEK_END);                       //Функция fseek перемещает указатель позиции в потоке.SEEK_END - Конец файла
    *Length = ftell(file);                          //Функция ftell возвращает значение указателя текущего положения потока.Т.е в переменную Length
                                                    //записывается значение соответствующее количеству байт от начала файла.(Для бинарных потоков)
    fseek(file, 0, SEEK_SET);                       //SEEK_SET - Начало файла
    for (int i = 0; i < 256; i++) {
        arr[i] = 0;
    }
    fseek(file, 0, SEEK_SET);
    unsigned char data = 0;
    for (unsigned long i = 0; i < *Length; i++) {
        fread_s(&data, sizeof(data), sizeof(data), 1, file);    //Считывает данные из потока.Место хранения данных-data.Размер буфера назначения в байтах-sizeof(data).
                                                                //Размер читаемого элемента в байтах-sizeof(data).Максимальное число читаемых элементов-1.Указатель на структуру FILE
        arr[(int)data]++;                                       //Через цикл в ячейки с номерами байтов записывается их количество 
    }
    fclose(file);
}

void SetColor(int text, int bg) {                                   //Функция для окрашивания текста
    HANDLE hStdOut = GetStdHandle(STD_OUTPUT_HANDLE);                      //Получаем дескриптор вывода на консоль
    SetConsoleTextAttribute(hStdOut, (WORD)((bg << 4) | text));              //Устанавливаем атрибуты текста
}

void tableVer(double limit, double* arrV, unsigned long Length) {   //Функция выводит значения вероятносте
    clear_window();

    GoToXY(0, 0);
    cout << "Количество байт в файле: " << Length << endl;

    cout << "Граничное значение: " << limit << endl;

    GoToXY(0, 2);
    for (int i = 0; i < 256; i++) {
        if (arrV[i] >= limit) {                                    //если значение перевалило за граничное значение
            SetColor(9, 0);                                      //изменяем цвет
            cout << i << " --> " << arrV[i] << endl;            //выводим окрашенное значение
            SetColor(7, 0);                                     //возвращаем обычный цвет
        }
        else {
            cout << i << " --> " << arrV[i] << endl;
        }
    }

}

void tableAmount(double limit, double* arr, double* arrV, unsigned long Length) {       //Функция выводит значения количества
    clear_window();

    GoToXY(0, 0);
    cout << "Количество байт в файле: " << Length << endl;

    cout << "Граничное значение: " << limit << endl;

    GoToXY(0, 2);
    for (int i = 0; i < 256; i++) {
        if (arr[i] >= limit) {                                    //если значение перевалило за граничное значение
            SetColor(9, 0);                                      //изменяем цвет
            cout << i << " --> " << arr[i] << endl;            //выводим окрашенное значение
            SetColor(7, 0);                                     //возвращаем обычный цвет
        }
        else {
            cout << i << " --> " << arr[i] << endl;
        }
    }

}

int main(int argv, char* argc[])
{
    system("cls");                              //функция очищает экран консоли
    setlocale(0, "");
    double limit;
    cout << "Введите граничное значение: ";
    cin >> limit;
    double* arrV = new double[256];             //Динамический массив со значениями вероятностей
    double* arr_wo_V = new double[256];          //Динамический массив со количества
    unsigned long Length;                       //длина файла(количество байт)

    aAmount(arr_wo_V, &Length, argc[1]);     //переход к функции, которая заполняет массив с количеством
    aVer(arr_wo_V, arrV, Length);             //переход к функции которая заполняет массив с вероятностью

    char n;
    cout << "Вывести таблицу с вероятностью - 1\t" << "Вывести таблицу с количеством - 2" << endl;;
    cin >> n;
    if (n == '1') { 
        tableVer(limit, arrV, Length);
    }
    if (n == '2') { 
        tableAmount(limit, arr_wo_V, arrV, Length);
    }

}
